//Valley RAT Detection (https://hexastrike.com/resources/blog/threat-intelligence/valleyrat-exploiting-byovd-to-kill-endpoint-security/)
// thx Maurice Fielenbach Blog Post which served as inspiration for this detection
DeviceRegistryEvents
| where ActionType == "RegistryValueSet" and RegistryValueName == "ImagePath"
//| where 
| where RegistryKey matches regex @"HKEY_LOCAL_MACHINE\\SYSTEM\\(ControlSet.*|CurrentControlSet)\\Services\\"
| where RegistryValueData has_any ("%TEMP%", @"%LOCALAPPDATA%\Temp", @"C:\Windows\Temp", @"\AppData\Local\Temp", @"C:\ProgramData")
| where not(RegistryValueData 
            has_any (@"C:\ProgramData\Microsoft\Windows Defender\Platform\",
                     @"\??\C:\ProgramData\Microsoft\Windows Defender\Definition Updates\"))
