# *CVE-2025-33073 SMB Reflection Exploit Detection (EXPERIMENTAL)*

## Query Information

#### MITRE ATT&CK Technique(s)

| Technique ID | Title    | Link    |
| ---  | --- | --- |
| T1059 | Command and Scripting Interpreter | https://attack.mitre.org/techniques/T1059 |

#### Description
The detection is based on identifying the two critical phases of the reflection attack. First, the query looks for SMB reflection on Port 445 by filtering connections where the device's local IP address matches the remote IP address, indicating an unusual connection to itself. To reduce false positives, the query excludes harmless loopback addresses (127.0.0.1, ::1) and focuses on reflection via the real host IP address, which is required for this exploit. The most critical step is the tight temporal correlation: the query demands that the suspicious reflection is followed by the creation of a shell process (cmd.exe, powershell.exe) with the maximum NT AUTHORITY\SYSTEM privileges within 5 seconds. This specific chain of events—reflection on the host IP plus immediate SYSTEM code execution—is unique to the successful exploit.

Joins with process creation events to see if a SYSTEM-level process starts soon after the suspicious network activity.
Filters specifically for shell executables that attackers often use during exploitation (e.g., cmd.exe, powershell.exe).
Close Temporal Window (5 Seconds)

Ensures a strong correlation between SMB reflection and process creation by narrowing the time gap to 5 seconds.
This small window increases confidence that the network and process events are related.
This detection can be used to identify possible SMB reflection attacks, where network connections to localhost over privileged ports lead to subsequent execution of malicious shell commands as SYSTEM.

#### Risk
SMB Reflection Detection

#### Author <Optional>
- **Name: Benjamin Zulliger**
- **Github: https://github.com/benscha/KQLAdvancedHunting**
- **LinkedIn: https://www.linkedin.com/in/benjamin-zulliger/**

#### References
- https://www.cve.org/CVERecord?id=CVE-2025-33073

## Defender XDR
```KQL
let smb_reflection_candidates = DeviceNetworkEvents
| where Timestamp > ago(7d)
| where ActionType == "ConnectionSuccess"
| where RemotePort == 445
| where LocalPort !in (445, 139)
| extend LocalIP = trim(' ', LocalIP)
| extend RemoteIP = trim(' ', RemoteIP)
| where LocalIP == RemoteIP
| where RemoteIP !in ("127.0.0.1", "::1", "::ffff:127.0.0.1")
| where InitiatingProcessFileName in ("ntkrnlmp.exe", "ntoskrnl.exe", "System")
// Search for the subsequent process execution with SYSTEM privileges
smb_reflection_candidates
| join kind=inner (
    DeviceProcessEvents
    | where Timestamp > ago(7d)
    | where ActionType == "ProcessCreated"
    | where AccountName startswith "NT AUTHORITY\\SYSTEM"
    // Focus on shell processes used by an exploit
    | where FileName in ("cmd.exe", "powershell.exe", "pwsh.exe", "whoami.exe", "wscript.exe", "cscript.exe")
    | project ProcessTime = Timestamp, DeviceId, FileName, ProcessCommandLine, AccountName, ProcessId
) on DeviceId
| where ProcessTime between (NetworkTime .. NetworkTime + 5s)
```

