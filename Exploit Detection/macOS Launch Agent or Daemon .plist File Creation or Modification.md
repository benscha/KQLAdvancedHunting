# *macOS Launch Agent/Daemon .plist File Creation or Modification*

## Query Information

#### MITRE ATT&CK Technique(s)

| Technique ID | Title    | Link    |
| ---  | --- | --- |
| T1543 | Create or Modify System Process | https://attack.mitre.org/techniques/T1543 |
| T1543.001 | Launch Agent | https://attack.mitre.org/techniques/T1543/001 |


#### Description
Detects the creation or modification of .plist files in macOS Launch Agent and Launch Daemon directories. This activity can be indicative of persistence mechanisms being established by adversaries. The rule excludes modifications by common system installers to reduce false positives.

#### Author <Optional>
- **Name: Benjamin Zulliger**
- **Github: https://github.com/benscha/KQLAdvancedHunting**
- **LinkedIn: https://www.linkedin.com/in/benjamin-zulliger/**

#### References
- https://www.sentinelone.com/blog/how-malware-persists-on-macos/


## Defender XDR
```KQL
DeviceFileEvents
| where ActionType in ("FileCreated", "FileModified")
| where FolderPath has_any (
    "/Library/LaunchAgents/",
    "/Library/LaunchDaemons/",
    "/System/Library/LaunchAgents/",
    "/System/Library/LaunchDaemons/"
    )
    or FolderPath contains "/Users/" and FolderPath contains "/Library/LaunchAgents/"
| where FileName endswith ".plist"
| where InitiatingProcessAccountName != "root" 
    or InitiatingProcessFileName !in ("installer", "softwareupdated", "installd")

```

