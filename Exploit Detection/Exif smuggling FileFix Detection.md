# *Exif smuggling FileFix Detection*

## Query Information

#### MITRE ATT&CK Technique(s)

| Technique ID | Title    | Link    |
| ---  | --- | --- |
| T1059.001 | Powershell | https://attack.mitre.org/techniques/T1562/001/ |
| T1027.010 | Command Obfuscation | https://attack.mitre.org/techniques/T1027/010/ |

#### Description
Detection based on: https://malwaretech.com/2025/10/exif-smuggling.html

This rule detects suspicious PowerShell execution patterns that might indicate an 'Exif smuggling FileFix Technique' or similar obfuscated command execution. It specifically looks for 'conhost.exe' launching PowerShell ('powershell.exe', 'pwsh.exe', 'pwsh.dll') with an encoded command ('-e' or '-EncodedCommand'), containing more than 5 spaces, and including a UNC path. This combination of indicators suggests an attempt to execute obfuscated PowerShell code, potentially from a remote source.

#### Author <Optional>
- **Name: Benjamin Zulliger**
- **Github: https://github.com/benscha/KQLAdvancedHunting**
- **LinkedIn: https://www.linkedin.com/in/benjamin-zulliger/**

#### References
- https://malwaretech.com/2025/10/exif-smuggling.html

## Defender XDR
```KQL
//Exif smuggling FileFix Technique
DeviceProcessEvents
| where ProcessCommandLine startswith "conhost.exe --headless"
| where ProcessCommandLine has_any ("powerhshell.exe", "pwsh.exe", "pwsh.dll")
//Checks for Encoded Command
| where ProcessCommandLine has "-e" or ProcessCommandLine has "-EncodedCommand"
//Checks if more than 5 Spaces are in the Command 
| where ProcessCommandLine matches regex " {5,}"
//Checks if a UNC Path is in the Comand
| where ProcessCommandLine matches regex @"\\\\([a-zA-Z0-9\-\.]+)\\[a-zA-Z0-9\-\.$_]+"
```
