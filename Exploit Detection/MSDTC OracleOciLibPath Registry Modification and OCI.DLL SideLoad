# *MSDTC OracleOciLibPath Registry Modification and OCI.DLL SideLoad*

## Query Information

#### MITRE ATT&CK Technique(s)

| Technique ID | Title    | Link    |
| ---  | --- | --- |
| T1622| Debugger Evasion | https://attack.mitre.org/techniques/T1622 |
| T1546.012 | Image File Execution Options Injection | https://attack.mitre.org/techniques/T1546/012/ |

#### Description

This rule detects suspicious activity related to Microsoft Distributed Transaction Coordinator (MSDTC) where the OracleOciLibPath registry value is modified, followed by msdtc.exe loading an unsigned oci.dll within a 4-hour window. This behavior can indicate an attempt to hijack the DLL loading process for persistence or privilege escalation, potentially by an attacker replacing the legitimate Oracle OCI library with a malicious one.

thx to Maurice Fielenbach for Sharing this Attack Path on Linkedin

#### Author <Optional>
- **Name: Benjamin Zulliger**
- **Github: https://github.com/benscha/KQLAdvancedHunting**
- **LinkedIn: https://www.linkedin.com/in/benjamin-zulliger/**

#### References
- https://www.linkedin.com/posts/mauricefielenbach_threatintel-threathunting-malwareanalysis-activity-7416547577200021505--ht8?utm_source=share&utm_medium=member_desktop&rcm=ACoAAA3PxAIBcfr6M0unx3xMtHTyCNuehMi3uNQ

## Defender XDR
```KQL
let RegistryModifications = 
    DeviceRegistryEvents
    | where RegistryKey has @"SOFTWARE\Microsoft\MSDTC\MTxOCI"
    | where RegistryValueName == "OracleOciLibPath"
    | project TimeOfRegistryWrite = TimeGenerated, DeviceId, DeviceName, 
              NewLibPath = RegistryValueData, InitiatingProcessFileName, 
              InitiatingProcessAccountName;
let DllLoads = 
    DeviceImageLoadEvents
    | where InitiatingProcessFileName =~ "msdtc.exe"
    | where FileName =~ "oci.dll"
    | project TimeOfDllLoad = TimeGenerated, DeviceId, LoadedDllPath = FolderPath, SHA256;
RegistryModifications
| join kind=inner DllLoads on DeviceId
| where TimeOfDllLoad between (TimeOfRegistryWrite .. (TimeOfRegistryWrite + 4h))
| invoke FileProfile(SHA256)
| where Signer !contains "Oracle"


```
