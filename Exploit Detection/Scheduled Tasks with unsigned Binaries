//Exclude false postive Filenames here
//please be aware that this query will need some whitelisting otherwise you will get a lot of f/p
let whitelistedBinaries = dynamic(["Qsync.exe"]);
//Exclude false poitive Filehashes here
let whitelistedSHA1Hashes = dynamic([ "9bb7c81dfae65eaf6abb743ba5b73451133c2791"]);
let scheduled_binaries = DeviceProcessEvents
| where InitiatingProcessCommandLine == "svchost.exe -k netsvcs -p -s Schedule"
| where not(ProcessCommandLine has_any (whitelistedBinaries))
| where not(SHA1 has_any (whitelistedSHA1Hashes))
| distinct SHA1;
let untrusted_binaries = scheduled_binaries
| join kind=leftanti (DeviceFileCertificateInfo | summarize max_trusted=max(IsTrusted) by SHA1 | where max_trusted==1) on SHA1;
untrusted_binaries
| invoke FileProfile(SHA1,1000)
| where IsCertificateValid != 1 // Exclude signed binaries
| where GlobalPrevalence < 1000
| join (DeviceProcessEvents | where InitiatingProcessCommandLine == "svchost.exe -k netsvcs -p -s Schedule") on SHA1
| summarize arg_max(Timestamp, *) by SHA1 // Give last execution with all details per SHA1
