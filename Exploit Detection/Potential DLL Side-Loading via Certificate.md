# *Potential DLL Side-Loading via Certificate*

## Query Information

#### MITRE ATT&CK Technique(s)

| Technique ID | Title    | Link    |
| ---  | --- | --- |
| T1574.001 | Hijack Execution Flow: DLL | https://attack.mitre.org/techniques/T1574/001/ |

#### Description
Based on the Article "Hackers Can Inject Malicious Code into Antivirus to Create a Backdoor" https://cybersecuritynews.com/malicious-code-into-antivirus/
This rule detects suspicious process command lines that indicate potential DLL side-loading. Specifically, it looks for an executable (ending in .exe) followed by three arguments, then a .cer file, and finally a path to a .dll file in the C:\ directory. This pattern can be indicative of an attacker using a legitimate certificate utility to load a malicious DLL.

The secondary, and more critical, part of this detection focuses on the subsequent Registry modifications that establish persistence and defense evasion. Specifically, the rule correlates the process execution event with immediate write operations (RegistryValueSet) to the critical Windows Cryptography API configuration path:

HKLM\SOFTWARE\Microsoft\Cryptography\Defaults\Provider

An attacker exploits this path by modifying one of its values (such as Image or Type) to point to their malicious DLL. This modification ensures that the malicious code is loaded by legitimate Windows processes, including those used by security products, typically upon service startup. The rule is therefore correlated: an alert is only triggered if the suspicious process execution is followed within a defined time window (e.g., 10 minutes) by a write operation to this specific Registry key containing a .dll reference in its data.

#### Risk
DLL Side Loading

#### Author <Optional>
- **Name: Benjamin Zulliger**
- **Github: https://github.com/benscha/KQLAdvancedHunting**
- **LinkedIn: https://www.linkedin.com/in/benjamin-zulliger/**

#### References
- https://cybersecuritynews.com/malicious-code-into-antivirus/

## Defender XDR
```KQL
// Based on the Article "Hackers Can Inject Malicious Code into Antivirus to Create a Backdoor" https://cybersecuritynews.com/malicious-code-into-antivirus/
let IAMAntiMalware = DeviceProcessEvents
| where ProcessCommandLine matches regex @"\w+\.exe\s+\S+\s+\S+\s+\S+\.cer\s+C:\\.*\.dll"
| project ProcessTimestamp = TimeGenerated, DeviceId, ProcessId, ProcessCommandLine;
DeviceRegistryEvents
| where ActionType == "RegistryValueSet"
| where RegistryValueData contains ".dll"
| where RegistryKey contains @"\SOFTWARE\Microsoft\Cryptography\Defaults\Provider"
| join kind=inner (IAMAntiMalware) on DeviceId
  | where Timestamp > ProcessTimestamp
  | where Timestamp - ProcessTimestamp < 10m

```


